 pipeline {
   agent any
   
  /*
    environment { 
        // getting stored credentials
        KUBECONFIG = credentials('kube_config') 
    } 
  */

   tools {
     maven 'maven397'
     nodejs "nodejs2241"	 
   }
   
   stages {

   
     stage('SCM') {
       steps {
         // git branch: 'main', url: 'https://github.com/abbassizied/angular-cicd-k8s.git'
         checkout scmGit(branches: [
           [name: '*/main']
         ], extensions: [], userRemoteConfigs: [
           [url: 'https://github.com/abbassizied/angular-cicd-k8s']
         ])
         echo 'Git Checkout Completed'
       }
     }

    // ##################################################################################################  

    stage('test k8s commands') {
        steps {
            script {
                withCredentials([
                    string(credentialsId: 'my_kubernetes', variable: 'api_token')
                ]) {
                    sh 'helm --token $api_token --server https://172.28.121.189:8443 --insecure-skip-tls-verify=true upgrade --install angularchart ./helm/angularchart'
                }
            }
        }         
    }

    // ##################################################################################################  
     stage('What\'s next?') {
       steps {
         echo 'What\'s next?'
       }
     }
   }
 }